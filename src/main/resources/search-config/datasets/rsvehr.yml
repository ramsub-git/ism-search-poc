# RSVEHR Dataset Configuration
# Reserve header records for inventory management

datasets:
  RSVEHR:
    baseTable: rsvehr

    columns:
      sku_id:
        sql: "base.sku_id"
        type: long
        alias: "skuId"
      location_number:
        sql: "base.location_number"
        type: int
        alias: "locationNumber"
#      channel_name:
#        sql: "base.channel_name"
#        type: string
      ats_flag:
        sql: "base.ats_flag"
        type: string
        alias: "atsFlag"
      hard_type:
        sql: "base.hard_type"
        type: string
        alias: "hardType"
      reservation_qty:
        sql: "base.reservation_qty"
        type: long
        alias: "reservationQty"

      channel:
        sql: "channel"
        type: string

      reservation_status:
        sql: "base.reservation_status"
        type: string
        alias: "reservationStatus"
      reservation_program:
        sql: "base.reservation_program"
        type: string
        alias: "reservationProgram"
      reservation_start_ts:
        sql: "base.reservation_start_ts"
        type: timestamp
        alias: "startTime"
      hard_reservation_end_ts:
        sql: "base.reservation_end_ts"
        type: timestamp
        alias: "endTime"
      reservation_last_modified_ts:
        sql: "base.reservation_last_modified_ts"
        type: timestamp
        alias: "lastModified"

    filters:
      skuIdIn:
        column: "base.sku_id"
        type: "long[]"
        op: "IN"
        max: 5000
      locationNumberIn:
        column: "base.location_number"
        type: "int[]"
        op: "IN"
        max: 1000
#      channelNameIn:
#        column: "base.channel_name"
#        type: string
#        op: "IN"
#        allowed: ["D", "R","H"]
      atsFlagIn:
        column: "base.ats_flag"
        type: string
        op: "IN"
        allowed: [ "Y", "N","E"]
      hardTypeIn:
        column: "base.hard_type"
        type: string
        op: "IN"
        allowed: [ "Y", "N"
        ]
      reservationStatusIn:
        column: "base.reservation_status"
        type: string
        op: "IN"
        allowed: ["A", "P", "T","D"]

      channel:
        column: "channel"
        type: string
        op: "="
        allowed: [ "D", "R" ]

      reservationStatus:
        column: "base.reservation_status"
        type: string
        op: "="
        allowed: [ "A", "P", "T","D" ]
      reservationProgram:
        column: "base.reservation_program"
        type: string
        op: "="
      startAfter:
        column: "base.reservation_start_ts"
        type: timestamp
        op: ">="
      endBefore:
        column: "base.reservation_end_ts"
        type: timestamp
        op: "<="
      # New filter for location type via join
      locationTypeIn:
        column: "loc.loc_type"
        type: "string[]"
        op: "IN"
        allowed: ["STORE", "DC", "VENDOR", "INTRANSIT"]
      locationTerritory:
        column: "loc.loc_territory"
        type: "string"
        op: "="
      locationName:
        column: "loc.loc_name"
        type: string
        op: "="

      derivedReserveType:
        column: "derivedReserveType"
        type: string
        op: "="
        allowed: [ "DOTHRY", "DOTRSV", "RETHRY", "RETRSV" ]

    # Join to location_master for filtering by location attributes
    joins:
      location:
        type: left
        table: "location_master loc"
        on: "loc.loc_number = base.location_number"
        columns:
          location_name:
            sql: "loc.loc_name"
            type: string
            alias: "locationName"
          location_type:
            sql: "loc.loc_type"
            type: string
            alias: "locationType"
          region_name:
            sql: "loc.region_name"
            type: string
            alias: "regionName"
          loc_territory:
            sql: "loc.loc_territory"
            type: string
            alias: "locTerritory"

    pagination:
      keysetColumns: ["sku_id"]
      defaultPageSize: 100
      maxPageSize: 500
      maxUnpaginatedRows: 10000

    defaultSort:
      - field: "lastModified"
        direction: "DESC"

    views:
      ActiveReserves:
        name: "ActiveReserves"
        description: "Currently active reservations"
        columns:
          - "sku_id"
          - "location_number"
          - "reservation_qty"
          - "reservation_start_ts"
          - "reservation_end_ts"
        filters:
          - "skuIdIn"
          - "locationNumberIn"
          - "channel"
          - "reservationStatus"
          - "locationTypeIn"
          - "locationTerritory"
        includes:
          - "location"
        defaultPageSize: 100

      ReserveHistory:
        name: "ReserveHistory"
        description: "Historical reserve audit trail"
        columns:
          - "id"
          - "sku_id"
          - "location_number"
          - "reservation_status"
          - "reservation_program"
          - "reservation_qty"
          - "reservation_last_modified_ts"
        filters:
          - "skuIdIn"
          - "locationNumberIn"
          - "startAfter"
          - "endBefore"
          - "locationTypeIn"
          - "locationTerritory"
        includes:
          - "location"
        defaultSort:
          - field: "reservation_last_modified_ts"
            direction: "DESC"

      # New view that includes location information
      ReservesByLocation:
        name: "ReservesByLocation"
        description: "Reserves with location details"
        columns:
          - "sku_id"
          - "location_number"
#          - "channel_name"
          - "reservation_qty"
          - "reservation_status"
          - "reservation_start_ts"
          - "hard_reservation_end_ts"
          - "reservation_last_modified_ts"
          - "ats_flag"
          - "hard_type"
        filters:
          - "skuIdIn"
          - "reservationStatusIn"
#          - "channelNameIn"
          - "atsFlagIn"
          - "hardTypeIn"
          - "locationTerritory"
          - "locationName"
          - "locationNumberIn"
        includes:
          - "location"
        defaultPageSize: 100

# Enhanced rsvehr.yml with derived reserve types
